name: tier_3_final_test
version: 1.0.0
variables:
  user_ids: [1, 2, 3]
  
start_task: initialize_counter

tasks:
  # --- While Loop Test ---
  initialize_counter:
    task_id: initialize_counter
    operator_type: task
    function: tools.memory.set
    args: ["loop_counter", 0]
    dependencies: []
    result_key: "init_counter"
  
  main_while_loop:
    task_id: main_while_loop
    operator_type: while
    condition: "{{memory.loop_counter}} < 3"
    dependencies: ["initialize_counter"]
    loop_body:
      - task_id: increment_counter
        operator_type: task
        function: "tools.memory.increment"
        args: ["loop_counter"]
        dependencies: [] # No dependencies *within* the loop
        result_key: "counter_result"
        
  log_while_complete:
    task_id: log_while_complete
    operator_type: task
    function: tools.log.info
    args: ["While loop complete. Final counter: {{memory.loop_counter}}"]
    dependencies: ["main_while_loop"]

  # --- ForEach Loop Test ---
  process_users_foreach:
    task_id: process_users_foreach
    operator_type: foreach
    items: "{{variables.user_ids}}"
    dependencies: ["log_while_complete"]
    loop_body:
      - task_id: fetch_user
        operator_type: task
        function: tools.fetch.get
        args: ["https://jsonplaceholder.typicode.com/users/{{item}}"]
        dependencies: []
        result_key: "user_data"
        
      - task_id: log_user
        operator_type: task
        function: tools.log.info
        args: ["Fetched user: {{results.user_data.data.name}} (ID: {{item}})"]
        dependencies: ["fetch_user"] # Depends on the *other task in the loop_body*

  log_end:
    task_id: log_end
    operator_type: task
    function: tools.log.info
    args: ["Tier 3 Test Finished."]
    dependencies: ["process_users_foreach"]
