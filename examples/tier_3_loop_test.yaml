name: tier_3_loop_test
version: 1.0.0
variables:
  user_ids: [1, 2, 3]
  
start_task: initialize_counter

tasks:
  # --- Main Graph Tasks ---
  initialize_counter:
    task_id: initialize_counter
    operator_type: task
    function: tools.memory.set
    args: ["loop_counter", 0]
    dependencies: []
    result_key: "init_counter"
  
  main_while_loop:
    task_id: main_while_loop
    operator_type: while
    condition: "{{memory.loop_counter}} < 3"
    dependencies: ["initialize_counter"]
    # loop_body is now just a list of task IDs
    loop_body: ["increment_counter"]
        
  log_while_complete:
    task_id: log_while_complete
    operator_type: task
    function: tools.log.info
    args: ["While loop complete. Final counter: {{memory.loop_counter}}"]
    dependencies: ["main_while_loop"]

  process_users_foreach:
    task_id: process_users_foreach
    operator_type: foreach
    items: "{{variables.user_ids}}"
    dependencies: ["log_while_complete"]
    # loop_body is a list of task IDs
    loop_body: ["fetch_user", "log_user"]

  log_end:
    task_id: log_end
    operator_type: task
    function: tools.log.info
    args: ["Tier 3 Test Finished."]
    dependencies: ["process_users_foreach"]

  # --- Loop Body Task Definitions ---
  # These tasks are now part of the main 'tasks' dict
  
  # Task for 'main_while_loop'
  increment_counter:
    task_id: increment_counter
    operator_type: task
    # This must be a safe, atomic operation.
    # We will assume a tool "tools.memory.increment" exists
    function: "tools.memory.increment"
    args: ["loop_counter"]
    dependencies: []
        
  # Tasks for 'process_users_foreach'
  fetch_user:
    task_id: fetch_user
    operator_type: task
    function: tools.fetch.get
    # '{{item}}' is injected by the handler
    args: ["https://jsonplaceholder.typicode.com/users/{{item}}"]
    dependencies: [] # Depends on the loop operator
    result_key: "user_data"
        
  log_user:
    task_id: log_user
    operator_type: task
    function: tools.log.info
    args: ["Fetched user: {{results.user_data.data.name}} (ID: {{item}})"]
    dependencies: ["fetch_user"]
